<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Docks — Portal del Locatario</title>
  <script src="config/config.js"></script>
  <style>
    :root{--blue:#2563eb;--green:#16a34a;--red:#dc2626;--bg:#f6f7fb}
    *{box-sizing:border-box} body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:var(--bg);color:#111}
    header{background:#fff;border-bottom:1px solid #e5e7eb;padding:14px 20px;display:flex;justify-content:space-between;align-items:center}
    main{max-width:1000px;margin:20px auto;padding:0 16px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:16px;margin:14px 0;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    h1{margin:0;font-size:22px} h2{margin:0 0 10px;font-size:18px}
    label{display:block;margin-top:10px;font-weight:600}
    input,select,textarea,button{padding:10px;margin-top:4px} textarea{min-height:110px}
    button{background:var(--blue);color:#fff;border:0;border-radius:8px;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .row{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
    .muted{color:#6b7280} .ok{color:var(--green)} .err{color:var(--red)}
    table{width:100%;border-collapse:collapse} th,td{border:1px solid #e5e7eb;padding:8px;text-align:left} th{background:#f8fafc}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:12px}
  </style>
</head>
<body>
<header>
  <div><strong>Docks del Puerto</strong> · Portal Locatario</div>
  <nav><a href="admin_docks.html" style="text-decoration:none;color:#374151">Administración</a></nav>
</header>
<main>
  <div class="card">
    <h2>Nuevo reclamo</h2>
    <form id="frm">
      <div class="row">
        <div>
          <label>Número de Local</label>
          <input id="local" placeholder="Ej. 012" required>
        </div>
        <div>
          <label>Categoría</label>
          <select id="cat">
            <option value="mantenimiento">mantenimiento</option>
            <option value="limpieza">limpieza</option>
            <option value="seguridad">seguridad</option>
            <option value="otros">otros</option>
          </select>
        </div>
      </div>
      <label>Detalle</label>
      <textarea id="det" placeholder="Describe el problema" required></textarea>
      <button id="send" type="submit">Enviar reclamo</button>
      <span id="msg" class="muted"></span>
    </form>
  </div>

  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:end;gap:12px;flex-wrap:wrap">
      <div>
        <h2 style="margin-bottom:6px">Mis reclamos</h2>
        <div class="muted" style="font-size:12px">Se listan los registros de la hoja <strong>Reclamos</strong>.</div>
      </div>
      <div style="display:flex;gap:10px;align-items:center">
        <input id="f_local" placeholder="Filtrar por local" style="padding:8px;border:1px solid #e5e7eb;border-radius:8px">
        <button id="btnListar" type="button" style="background:#374151">Actualizar</button>
      </div>
    </div>
    <div style="overflow:auto;margin-top:10px">
      <table>
        <thead><tr><th>Fecha</th><th>Local</th><th>Categoría</th><th>Detalle</th><th>Estado</th></tr></thead>
        <tbody id="rows"><tr><td colspan="5" class="muted">Cargando…</td></tr></tbody>
      </table>
    </div>
  </div>
</main>

<script>
function today(){const d=new Date(),p=n=>String(n).padStart(2,'0');return d.getFullYear()+"-"+p(d.getMonth()+1)+"-"+p(d.getDate());}
async function listReclamos(){ const r=await fetch(window.build('list',{tabla:'Reclamos'})); return r.json(); }
async function crearReclamo(obj){ const body=new URLSearchParams(Object.assign({tabla:'Reclamos',ID:'',Estado:'Abierto'},obj)); const r=await fetch(window.build('create'),{method:'POST',body}); return r.json(); }

async function render(){
  const tb=document.getElementById('rows'); tb.innerHTML='<tr><td colspan="5" class="muted">Cargando…</td></tr>';
  try{
    const res=await listReclamos();
    const fl=(document.getElementById('f_local').value||'').trim().toLowerCase();
    const rows=(res.rows||[]).filter(x=>!fl||String(x.Local||'').toLowerCase().includes(fl));
    tb.innerHTML = rows.map(r=>`<tr>
      <td>${r.Fecha||''}</td><td>${r.Local||''}</td><td><span class="pill">${r.Categoria||''}</span></td>
      <td>${r.Detalle||''}</td><td>${r.Estado||''}</td>`).join('') || '<tr><td colspan="5" class="muted">Sin datos</td></tr>';
  }catch(e){ tb.innerHTML='<tr><td colspan="5" class="err">Error listando</td></tr>'; }
}
document.getElementById('btnListar').onclick=render;

document.getElementById('frm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const msg=document.getElementById('msg'), btn=document.getElementById('send');
  btn.disabled=true; msg.textContent='Enviando…';
  const res=await crearReclamo({Fecha:today(), Local:local.value.trim(), Categoria:cat.value, Detalle:det.value.trim(), Responsable:''});
  msg.textContent = res.ok ? 'Reclamo enviado. ID: '+res.id : ('Error: '+(res.error||'desconocido'));
  btn.disabled=false; if(res.ok){ e.target.reset(); render(); }
});

render();
</script>
</body>
</html>
