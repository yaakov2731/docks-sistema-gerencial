<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Docks Admin</title>
  <script src="config/config.js"></script>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:24px;max-width:1100px}
    h1{margin:0 0 12px 0}
    .bar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:16px}
    label{font-weight:600}
    input,select,textarea,button{padding:8px;margin:3px 0}
    table{border-collapse:collapse;width:100%}
    th,td{border:1px solid #ddd;padding:6px;text-align:left}
    th{background:#f7f7f7}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
    .box{border:1px solid #e5e5e5;padding:12px;border-radius:8px;margin:10px 0}
    .muted{color:#666}
    .ok{color:#0a7a0a} .err{color:#a00}
    .actions button{margin-right:6px}
    .small{font-size:12px}
  </style>
</head>
<body>
<h1>Docks – Panel Admin</h1>

<div class="bar">
  <label for="tabla">Tabla</label>
  <select id="tabla">
    <option>Gastos</option>
    <option>Locales</option>
    <option>Expensas</option>
    <option>Reclamos</option>
    <option>Sugerencias</option>
  </select>
  <button id="btnListar">Listar</button>
  <span id="state" class="muted small"></span>
</div>

<div class="box">
  <h3>Crear</h3>
  <form id="formCrear" class="grid"></form>
  <button id="btnCrear">Crear</button>
  <span id="msgCrear" class="small"></span>
</div>

<div class="box">
  <h3>Actualizar</h3>
  <input id="upd_id" placeholder="ID" style="width:320px">
  <form id="formActualizar" class="grid"></form>
  <button id="btnActualizar">Actualizar</button>
  <span id="msgActualizar" class="small"></span>
</div>

<div class="box">
  <h3>Listado</h3>
  <table id="tbl"><thead></thead><tbody></tbody></table>
</div>

<script>
// ====== SCHEMA ======
const SCHEMA = {
  "Gastos":        ["Fecha","Concepto","Importe","Medio","Observaciones"],
  "Locales":       ["Nombre","Rubro","Email","Telefono","Estado"],
  "Expensas":      ["Fecha","Local","Concepto","Monto","Estado"],
  "Reclamos":      ["Fecha","Local","Categoria","Detalle","Estado","Responsable"],
  "Sugerencias":   ["Fecha","Local","Mensaje","Estado"]
};

function el(tag, attrs={}, children=[]) {
  const e = document.createElement(tag);
  Object.entries(attrs).forEach(([k,v])=> { if(k in e) e[k]=v; else e.setAttribute(k,v); });
  children.forEach(c => e.appendChild(typeof c==='string' ? document.createTextNode(c) : c));
  return e;
}

function renderForms(tabla){
  const crear = document.getElementById('formCrear'); crear.innerHTML='';
  const upd   = document.getElementById('formActualizar'); upd.innerHTML='';
  (SCHEMA[tabla]||[]).forEach(c=>{
    crear.appendChild(el('div',{},[el('label',{htmlFor:'c_'+c, textContent:c}), el('input',{id:'c_'+c, placeholder:c})]));
    upd.appendChild(el('div',{},[el('label',{htmlFor:'u_'+c, textContent:c}), el('input',{id:'u_'+c, placeholder:c})]));
  });
}

async function apiGet(action, params={}){
  const url = window.build(action, params);
  const r = await fetch(url);
  const t = await r.text();
  try { return JSON.parse(t) } catch(e){ return {raw:t} }
}
async function apiPost(action, params={}){
  const url = window.build(action);
  const body = new URLSearchParams(params);
  const r = await fetch(url, {method:'POST', body});
  const t = await r.text();
  try { return JSON.parse(t) } catch(e){ return {raw:t} }
}

// ====== UI hooks ======
const tablaSel = document.getElementById('tabla');
renderForms(tablaSel.value);
tablaSel.onchange = ()=> renderForms(tablaSel.value);

document.getElementById('btnListar').onclick = async ()=>{
  document.getElementById('state').textContent = 'Cargando...';
  const tabla = tablaSel.value;
  const res = await apiGet('list', {tabla});
  document.getElementById('state').textContent = res.ok ? 'OK' : ('Error: ' + (res.error||'desconocido'));
  renderTable(tabla, res.rows || []);
};

document.getElementById('btnCrear').onclick = async ()=>{
  const tabla = tablaSel.value;
  const params = { tabla, ID:'' };
  SCHEMA[tabla].forEach(c=> params[c] = document.getElementById('c_'+c).value );
  const res = await apiPost('create', params);
  const msg = document.getElementById('msgCrear');
  msg.textContent = res.ok ? ('OK. ID ' + res.id) : ('Error: ' + (res.error||JSON.stringify(res)));
};

document.getElementById('btnActualizar').onclick = async ()=>{
  const tabla = tablaSel.value;
  const id = document.getElementById('upd_id').value;
  const params = { tabla, id };
  SCHEMA[tabla].forEach(c=> {
    const v = document.getElementById('u_'+c).value;
    if(v!=="") params[c]=v;
  });
  const res = await apiPost('update', params);
  const msg = document.getElementById('msgActualizar');
  msg.textContent = res.ok ? 'OK' : ('Error: ' + (res.error||JSON.stringify(res)));
};

function renderTable(tabla, rows){
  const thead = document.querySelector('#tbl thead');
  const tbody = document.querySelector('#tbl tbody');
  thead.innerHTML=''; tbody.innerHTML='';
  const cols = ["ID"].concat(SCHEMA[tabla]||[]).concat(["_acciones"]);
  thead.appendChild(el('tr',{}, cols.map(c=>el('th',{},[c==="__acciones"?"":"", c.replace('_','')]))));
  rows.forEach(r=>{
    const tr = el('tr');
    cols.forEach(c=>{
      if(c==="_acciones"){
        const td = el('td', {className:'actions'});
        td.appendChild(btnDel(r.ID));
        td.appendChild(btnEditPrefill(r));
        tr.appendChild(td);
      } else {
        tr.appendChild(el('td',{},[String(r[c]||'')]));
      }
    });
    tbody.appendChild(tr);
  });
}
function btnDel(id){
  const b = el('button',{textContent:'Borrar'});
  b.onclick = async ()=>{
    if(!confirm('¿Borrar '+id+'?')) return;
    const res = await apiPost('delete', {tabla: tablaSel.value, id});
    alert(res.ok ? 'Borrado' : ('Error: '+(res.error||'desconocido')));
  };
  return b;
}
function btnEditPrefill(row){
  const b = el('button',{textContent:'Editar'});
  b.onclick = ()=>{
    document.getElementById('upd_id').value = row.ID || '';
    (SCHEMA[tablaSel.value]||[]).forEach(c=>{
      document.getElementById('u_'+c).value = row[c] || '';
    });
    window.scrollTo({top:0, behavior:'smooth'});
  };
  return b;
}

// Auto listar al abrir
document.getElementById('btnListar').click();
</script>
</body>
</html>
